#!/bin/bash

getparted=($(lsblk -o path,type | grep "part"))
recparted=()

## FILTER PARTITION
for reco_part in "${getparted[@]}"; do
    if [[ ! -z $( echo $reco_part | grep mapper ) ]];then
        continue
    fi
    if [[ $( echo $reco_part ) == "part"  ]];then
        continue
    fi
    allparted+=("$reco_part")
done


## LISTING PARTEDS
function recovery_listing_parteds() {
    index=0
    for index in "${!recparted[@]}"; do
        echo "[$index] ${recparted[$index]}"
    done
} 


## SELECT BOOTDISK
function recovery_select_bootdisk() {
    echo "Select Your Boot Partition"
    recovery_listing_parteds
    read -p "Type Number of Boot Partition : " bootnum
    RECBOOTPART="${recparted[$bootnum]}"
    unset 'recparted[$bootnum]'
}


## MOUNT BOOTDISK
function recovery_mounts_bootdisk() { 
    mkir -p /srv/profile
    mount $RECBOOTPART /srv/profile
    openssl enc -d -aes-256-cbc -pbkdf2 -in /srv/profile/data/loader.temp -out /recover-profile
    cat /recover-profile > $appdir/config/define/post/packer
    umount -R /srv/profile
}


function system_resetter() {
    recovery_listing_parteds && 
    recovery_select_bootdisk &&
    recovery_mounts_bootdisk
}

