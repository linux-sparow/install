#!/bin/bash

getrepart=($(lsblk -o path,type | grep "part"))
recparted=()


## FILTER PARTITION
for reco_part in "${getrepart[@]}"; do
    if [[ ! -z $( echo $reco_part | grep mapper ) ]];then
        continue
    fi
    if [[ $( echo $reco_part ) == "part"  ]];then
        continue
    fi
    recparted+=("$reco_part")
done


## LISTING PARTEDS
function recovery_listing_parteds() {
    index=0
    for index in "${!recparted[@]}"; do
        echo "[$index] ${recparted[$index]}"
    done
} 


## SELECT BOOTDISK
function recovery_select_bootdisk() {
    echo "Select Your Boot Partition"
    recovery_listing_parteds
    read -p "Type Number of Boot Partition : " reconum
    RECBOOTPART="${recparted[$reconum]}"
    unset 'recparted[$reconum]'
}


## MOUNT BOOTDISK
function recovery_mounts_bootdisk() { 
    mkdir -p /srv/profile &&
    mount $RECBOOTPART /srv/profile &&
    openssl enc -d -aes-256-cbc -pbkdf2 -in /srv/profile/data/loader.temp -out $appdir/config/define/post/packer &&

    if [[ -e /srv/profile/intel-ucode.img ]];then
        rm /srv/profile/intel-ucode.img
    fi

    if [[ -e /srv/profile/amd-ucode.img ]];then
        rm /srv/profile/amd-ucode.img
    fi

    if [[ -e /srv/profile/vmlinuz-* ]];then
        rm /srv/profile/vmlinuz-*
    fi

    if [[ -e /srv/profile/initramfs-* ]];then
        rm /srv/profile/initramfs-*
    fi

    umount -R /srv/profile
}


## START PROCCESS
function system_resetter() {
    recovery_select_bootdisk &&
    recovery_mounts_bootdisk
}