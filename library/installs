#!/bin/bash

## CLEANSING
if [[ ! -z $(findmnt --mountpoint /mnt) ]]; then 
    umount -R /mnt
fi



## ENVIRONTMENT
## appdir=/install
appdir=$(pwd)

export PACKAGE=""
export RDAEMON=""
export GDAEMON=""


if [[ $1 == "--purge" ]]; then
    #nano $appdir/config/profile
    echo "debug"
fi

if [[ -e "$appdir/config/profile" ]]; then
    cat "$appdir/config/profile" > $appdir/config/define/post/packer
fi 

if [[ -e "$appdir/config/preset" ]]; then
    cat "$appdir/config/preset" >> $appdir/config/define/post/packer &&
    source $appdir/config/preset 
fi 

if [[ -e "$appdir/library/kernel/$DISTRO_KERN/preset" ]]; then
    source $appdir/library/kernel/$DISTRO_KERN/preset
fi

if [[ -e "$appdir/library/system/$DISTRO_SYST/preset" ]]; then
    source $appdir/library/system/$DISTRO_SYST/preset
fi

if [[ -e "$appdir/library/kernel/$DISTRO_BOOT/preset" ]]; then
    source $appdir/library/booter/$DISTRO_BOOT/preset
fi

if [[ -e "$appdir/library/deskto/$DISTRO_DESK/preset" ]]; then
    source $appdir/library/deskto/$DISTRO_DESK/preset
fi

if [[ -e "$appdir/library/audios/$DISTRO_AUDI/preset" ]]; then
    source $appdir/library/audios/$DISTRO_AUDI/preset
fi

if [[ -e "$appdir/config/distros" ]]; then
    source $appdir/config/distros
fi


echo "PACKAGES='${PACKAGE}'" >> $appdir/config/define/post/packer &&
echo "RDAEMONS=(${RDAEMON})" >> $appdir/config/define/post/packer &&
echo "GDAEMONS=(${GDAEMON})" >> $appdir/config/define/post/packer &&


## LOAD PRESETS
source $appdir/config/define/post/packer


## SYSPARTED
mkfs.ext4 -F -q -b 4096 $DISKPROC &&
mount $DISKPROC /mnt &&


## BOOTINGUP
if [[ $1 == "--purge" ]]; then
    mkfs.vfat -F32 -S 4096 -n BOOT $DISKBOOT
fi
mkdir -p /mnt/boot && 
mount -o uid=0,gid=0,dmask=007,fmask=007 $DISKBOOT /mnt/boot/ &&


## USERDATUM
if [[ $1 == "--purge" ]]; then
    mkfs.ext4 -F -q -b 4096 $DISKDATA
fi
mkdir -p /mnt/home &&
mount $DISKDATA /mnt/home &&



# PROCESSOR
procieidven=$(grep "vendor_id" /proc/cpuinfo | head -n 1 | awk '{print $3}')


if [[ "$procieidven" == "GenuineIntel" ]]; then
    pacstrap /mnt intel-ucode $KERNEL_PACKAGE $SYSTEM_PACKAGE $AUDIO_PACKAGE $DESKTOP_PACKAGE $DISTRO_PACKER
elif [[ "$procieidven" == "AuthenticAMD" ]]; then
    pacstrap /mnt amd-ucode $KERNEL_PACKAGE $SYSTEM_PACKAGE $AUDIO_PACKAGE $DESKTOP_PACKAGE $DISTRO_PACKER
fi



# GRAPHICAL
graphidven=$(lspci | grep -i --color 'vga\')

if [[ ! -z $(echo $graphidven | grep -i --color 'Intel Corporation') ]];then
    pacstrap /mnt vulkan-intel
fi

if [[ ! -z $(lspci | grep -i --color '3d\|NVIDIA') ]];then
    pacstrap /mnt nvidia-utils
fi

if [[ ! -z $(lspci | grep -i --color '3d\|RADEON') ]];then
    pacstrap /mnt vulkan-radeon 
fi


# CONFIGURE
genfstab -U /mnt > /mnt/etc/fstab &&
cp -fr $appdir/config/define/* /mnt &&
arch-chroot /mnt /bin/bash /post/syscon &&



# FINISHING
rm -fr /mnt/post && sleep 2 && umount -R /mnt && reboot