#!/bin/bash


getparted=($(lsblk -o path,type | grep "part"))
getloader=($(lsblk -d -o path))
allparted=()
allloader=()
selecteds=""


## FILTER PARTITION
for alls_part in "${getparted[@]}"; do
    if [[ ! -z $( echo $alls_part | grep mapper ) ]];then
        continue
    fi
    if [[ $( echo $alls_part ) == "part"  ]];then
        continue
    fi
    allparted+=("$alls_part")
done

for load_part in "${getloader[@]}"; do
    if [[ ! -z $( echo $load_part | grep "PATH" ) ]];then
        continue
    fi
    allloader+=("$load_part")
done


## LISTING PARTEDS
function listing_parteds() {
    index=0
    for index in "${!allparted[@]}"; do
        echo "[$index] ${allparted[$index]}"
    done
} 


## SELECT BOOTDISK
function select_bootdisk() {
    echo "Select Boot Partition"
    listing_parteds
    read -p "Type Number of Boot Partition : " bootnum
    BOOTPART="${allparted[$bootnum]}"
    unset 'allparted[$bootnum]'
}


## SELECT ROOTDISK
function select_rootdisk() {
    echo "Select Root Partition"
    listing_parteds
    read -p "Type Number of Boot Partition : " rootnum
    ROOTPART="${allparted[$rootnum]}"
    unset 'allparted[$rootnum]'
}


## SELECT DATADISK
function select_datadisk() {
    echo "Select Root Partition"
    listing_parteds
    read -p "Type Number of Boot Partition : " datanum
    DATAPART="${allparted[$datanum]}"
    unset 'allparted[$rootnum]'
}


## SELECT BOOTLOAD
function select_bootload() {
    echo "Select Bootloader"
    for list in "${!allloader[@]}"; do
        echo "[$index] ${allloader[$list]}"
    done
    read -p "Type Number for Boot loader : " loadnum
    BOOTLOAD="${allloader[$loadnum]}"
}


## ADD ADMINISTRATOR
function create_administ() {
    echo "Create Administrator"
    read -p "username : " DATAUSER &&
    read -p "password : " DATAPASS &&
    read -p "timezone : " TIMEZONE
}


function profile_preview() {

    echo "This Your Configuration Data"
    echo " Boot Partition : $BOOTLOAD"
    echo " Boot Partition : $BOOTPART"
    echo " Boot Partition : $ROOTPART"
    echo " Boot Partition : $DATAPART"
    echo " Boot Partition : $DATAUSER"
    echo " Boot Partition : $DATAPASS"
    echo " Boot Partition : $TIMEZONE"
    read -p "Do you want continue using this data : [ Y/n ]" EXEC

    if [[ $EXEC == "Y" ]];then
        writing_profile
    elif [[ $EXEC == "y" ]];then
        writing_profile
    else
        start_installer
    fi
}


function writing_profile() {

    if [[ ! -e  $appdir/config/profile ]]; then
        touch $appdir/config/define/post/packer
    else
        echo "" > $appdir/config/define/post/packer
    fi

    echo "DISKMAIN=$BOOTLOAD" >  $appdir/config/define/post/packer &&
    echo "DISKBOOT=$BOOTPART" >> $appdir/config/define/post/packer &&
    echo "DISKPROC=$ROOTPART" >> $appdir/config/define/post/packer &&
    echo "DISKDATA=$DATAPART" >> $appdir/config/define/post/packer &&
    echo "USERNAME=$DATAUSER" >> $appdir/config/define/post/packer &&
    echo "PASSWORD=$DATAPASS" >> $appdir/config/define/post/packer &&
    echo "TIMEZONE=$TIMEZONE" >> $appdir/config/define/post/packer 
}


function start_installer() {
    clear &&
    select_bootdisk &&
    select_rootdisk &&
    select_datadisk &&
    select_bootload &&
    create_administ
}
